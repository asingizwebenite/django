<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Tasks - TaskManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#eff6ff",
                100: "#dbeafe",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
              },
            },
          },
        },
      };

      // Toggle task completion with visual feedback
function toggleTask(checkbox) {
    const taskId = checkbox.getAttribute('data-task-id');
    const originalState = checkbox.checked;
    
    // Show loading state
    checkbox.disabled = true;
    
    fetch(`{% url 'toggle' 0 %}`.replace('0', taskId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the UI without reloading
            const taskTitle = document.getElementById(`task-title-${taskId}`);
            const statusBadge = document.getElementById(`task-status-${taskId}`);
            
            // Toggle strikethrough and colors
            if (data.completed) {
                taskTitle.classList.add('line-through', 'text-gray-500');
                statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 transition-all duration-200';
                statusBadge.textContent = 'Completed';
            } else {
                taskTitle.classList.remove('line-through', 'text-gray-500');
                // Check if overdue
                const isOverdue = statusBadge.textContent === 'Overdue';
                if (isOverdue) {
                    statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 transition-all duration-200';
                    statusBadge.textContent = 'Overdue';
                } else {
                    statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 transition-all duration-200';
                    statusBadge.textContent = 'Pending';
                }
            }
            
            // Show success feedback
            showNotification(`Task ${data.completed ? 'completed' : 'marked as pending'}!`, 'success');
        } else {
            // Revert checkbox if error
            checkbox.checked = !originalState;
            showNotification('Error updating task status', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        checkbox.checked = !originalState;
        showNotification('Error updating task status', 'error');
    })
    .finally(() => {
        checkbox.disabled = false;
    });
}



      function confirmDelete(button) {
        const taskData = JSON.parse(button.getAttribute("data-task"));
        document.getElementById("taskTitle").textContent = taskData.title;
        document.getElementById("deleteForm").action =
          `{% url 'delete' 0 %}`.replace("0", taskData.id);
        document.getElementById("deleteModal").classList.remove("hidden");
      }
    </script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <div class="flex-shrink-0 flex items-center">
              <i class="fas fa-tasks text-primary-600 text-2xl mr-2"></i>
              <span class="text-xl font-bold text-gray-800">TaskManager</span>
            </div>
            <div class="hidden md:ml-6 md:flex md:space-x-8">
              <a
                href="{% url 'dashboard' %}"
                class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium"
                >Dashboard</a
              >
              <a
                href="#"
                class="border-primary-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium"
                >Tasks</a
              >
              <a
                href="{% url 'calendar' %}"
                class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium"
                >Calendar</a
              >
            </div>
          </div>
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <a
                href="{% url 'create' %}"
                class="relative inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
              >
                <i class="fas fa-plus mr-2"></i> New Task
              </a>
            </div>
            <div class="ml-4 flex items-center md:ml-6">
              <div class="ml-3 relative">
                <div class="flex items-center">
                  <span class="mr-2 text-sm font-medium text-gray-700"
                    >{{ user.username }}</span
                  >
                  <img
                    class="h-8 w-8 rounded-full"
                    src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=facearea&facepad=2&w=256&h=256&q=80"
                    alt=""
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <!-- Page Header -->
      <div class="px-4 py-6 sm:px-0">
        <div class="md:flex md:items-center md:justify-between">
          <div class="flex-1 min-w-0">
            <h1 class="text-3xl font-bold leading-tight text-gray-900">
              My Tasks
            </h1>
            <p class="mt-2 text-sm text-gray-600">
              Manage all your tasks in one place
            </p>
          </div>
          <div class="mt-4 flex md:mt-0 md:ml-4">
            <a
              href="{% url 'create' %}"
              class="ml-3 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
            >
              <i class="fas fa-plus mr-2"></i> Add Task
            </a>
          </div>
        </div>
      </div>

      <!-- Filters and Search -->
      <div class="mt-6 px-4 sm:px-0">
        <div class="bg-white shadow rounded-lg">
          <div class="px-4 py-5 sm:p-6">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
              <!-- Search -->
              <div>
                <label
                  for="search"
                  class="block text-sm font-medium text-gray-700"
                  >Search tasks</label
                >
                <div class="mt-1 relative rounded-md shadow-sm">
                  <input
                    type="text"
                    name="search"
                    id="search"
                    class="focus:ring-primary-500 focus:border-primary-500 block w-full pl-3 pr-10 py-2 sm:text-sm border-gray-300 rounded-md"
                    placeholder="Search tasks..."
                  />
                  <div
                    class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none"
                  >
                    <i class="fas fa-search text-gray-400"></i>
                  </div>
                </div>
              </div>

              <!-- Status Filter -->
              <div>
                <label
                  for="status"
                  class="block text-sm font-medium text-gray-700"
                  >Status</label
                >
                <select
                  id="status"
                  name="status"
                  class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md"
                >
                  <option value="all">All Tasks</option>
                  <option value="completed">Completed</option>
                  <option value="pending">Pending</option>
                  <option value="overdue">Overdue</option>
                </select>
              </div>

              <!-- Sort By -->
              <div>
                <label
                  for="sort"
                  class="block text-sm font-medium text-gray-700"
                  >Sort By</label
                >
                <select
                  id="sort"
                  name="sort"
                  class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md"
                >
                  <option value="newest">Newest First</option>
                  <option value="oldest">Oldest First</option>
                  <option value="due_date">Due Date</option>
                  <option value="title">Title</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tasks List -->
      <div class="mt-6 px-4 sm:px-0">
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
          <ul class="divide-y divide-gray-200">
            {% for task in tasks %}
            <li
              class="px-6 py-4 hover:bg-gray-50 transition-colors duration-150"
            >
              <div class="flex items-center justify-between">
                <div class="flex items-center flex-1 min-w-0">
                  <!-- Checkbox -->
<div class="flex-shrink-0 mr-4">
    <input type="checkbox" 
           {% if task.completed %}checked{% endif %}
           class="h-5 w-5 text-primary-600 focus:ring-primary-500 border-gray-300 rounded cursor-pointer transition-colors duration-200"
           onchange="toggleTask(this)"
           data-task-id="{{ task.id }}">
</div>


                  <!-- Task Info -->
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between">
                      <div>
                        <p
                          class="text-sm font-medium text-gray-900 truncate {% if task.completed %}line-through text-gray-500{% endif %} transition-all duration-200"
                          id="task-title-{{ task.id }}"
                        >
                          {{ task.title }}
                        </p>
                        {% if task.description %}
                        <p class="text-sm text-gray-500 mt-1 line-clamp-2">
                          {{ task.description }}
                        </p>
                        {% endif %}
                      </div>
                    </div>

                    <div
                      class="mt-2 flex items-center text-sm text-gray-500 space-x-4"
                    >
                      <!-- Created Date -->
                      <div class="flex items-center">
                        <i
                          class="fas fa-calendar-plus text-gray-400 mr-1.5"
                        ></i>
                        <span
                          >Created: {{ task.created_at|date:"M d, Y" }}</span
                        >
                      </div>

                      <!-- Due Date -->
                      {% if task.to_complete_at %}
                      <div
                        class="flex items-center {% if task.is_overdue and not task.completed %}text-red-600 font-medium{% endif %}"
                      >
                        <i class="fas fa-clock text-gray-400 mr-1.5"></i>
                        <span
                          >Due: {{ task.to_complete_at|date:"M d, Y" }}</span
                        >
                      </div>
                      {% endif %}

                      <!-- Priority -->
                      {% if task.priority %}
                      <div class="flex items-center">
                        <i class="fas fa-flag text-gray-400 mr-1.5"></i>
                        <span class="capitalize">{{ task.priority }}</span>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <!-- Status Badge and Actions -->
                <div class="flex items-center space-x-4 ml-4">
                  <!-- Status Badge -->
                  <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium transition-all duration-200 {% if task.completed %}bg-green-100 text-green-800 {% elif task.is_overdue %}bg-red-100 text-red-800 {% else %}bg-yellow-100 text-yellow-800{% endif %}"
                    id="task-status-{{ task.id }}"
                  >
                    {% if task.completed %}Completed {% elif task.is_overdue
                    %}Overdue {% else %}Pending{% endif %}
                  </span>

                  <!-- Action Buttons -->
                  <div class="flex items-center space-x-2">
                    <!-- Edit Button -->
                    <a
                      href="{% url 'update' task.id %}"
                      class="inline-flex items-center p-2 border border-transparent rounded-full shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-150"
                      title="Edit Task"
                    >
                      <i class="fas fa-edit w-4 h-4"></i>
                    </a>

                    <!-- Delete Button -->
                    <button
                      type="button"
                      data-task='{"id": {{ task.id }}, "title": "{{ task.title|escapejs }}"}'
                      onclick="confirmDelete(this)"
                      class="inline-flex items-center p-2 border border-transparent rounded-full shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-150"
                      title="Delete Task"
                    >
                      <i class="fas fa-trash w-4 h-4"></i>
                    </button>
                  </div>
                </div>
              </div>
            </li>
            {% empty %}
            <li class="px-6 py-12 text-center">
              <i class="fas fa-clipboard-list text-4xl text-gray-400 mb-4"></i>
              <h3 class="text-lg font-medium text-gray-900">No tasks found</h3>
              <p class="mt-2 text-sm text-gray-500">
                Get started by creating a new task.
              </p>
              <div class="mt-6">
                <a
                  href="{% url 'create' %}"
                  class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                >
                  <i class="fas fa-plus mr-2"></i> Create Your First Task
                </a>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Pagination -->
      {% if tasks.has_other_pages %}
      <div class="mt-6 px-4 sm:px-0">
        <div
          class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6"
        >
          <div class="flex-1 flex justify-between items-center">
            <div>
              <p class="text-sm text-gray-700">
                Showing
                <span class="font-medium">{{ tasks.start_index }}</span> to
                <span class="font-medium">{{ tasks.end_index }}</span> of
                <span class="font-medium">{{ tasks.paginator.count }}</span>
                results
              </p>
            </div>
            <div>
              <nav
                class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px"
              >
                {% if tasks.has_previous %}
                <a
                  href="?page={{ tasks.previous_page_number }}"
                  class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                >
                  <span class="sr-only">Previous</span>
                  <i class="fas fa-chevron-left"></i>
                </a>
                {% endif %} {% for num in tasks.paginator.page_range %}
                <a
                  href="?page={{ num }}"
                  class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium {% if tasks.number == num %}text-primary-600 bg-primary-50{% else %}text-gray-500 hover:bg-gray-50{% endif %}"
                >
                  {{ num }}
                </a>
                {% endfor %} {% if tasks.has_next %}
                <a
                  href="?page={{ tasks.next_page_number }}"
                  class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50"
                >
                  <span class="sr-only">Next</span>
                  <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
              </nav>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </main>

    <!-- Delete Confirmation Modal -->
    <div
      id="deleteModal"
      class="fixed z-10 inset-0 overflow-y-auto hidden"
      aria-labelledby="modal-title"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
      >
        <div
          class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
          aria-hidden="true"
        ></div>
        <span
          class="hidden sm:inline-block sm:align-middle sm:h-screen"
          aria-hidden="true"
          >&#8203;</span
        >
        <div
          class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6"
        >
          <div class="sm:flex sm:items-start">
            <div
              class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10"
            >
              <i class="fas fa-exclamation-triangle text-red-600"></i>
            </div>
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
              <h3
                class="text-lg leading-6 font-medium text-gray-900"
                id="modal-title"
              >
                Delete Task
              </h3>
              <div class="mt-2">
                <p class="text-sm text-gray-500">
                  Are you sure you want to delete "<span
                    id="taskTitle"
                    class="font-medium"
                  ></span
                  >"? This action cannot be undone.
                </p>
              </div>
            </div>
          </div>
          <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
            <form id="deleteForm" method="POST" class="inline-flex">
              {% csrf_token %}
              <button
                type="submit"
                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm"
              >
                Delete
              </button>
            </form>
            <button
              type="button"
              onclick="closeModal()"
              class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:w-auto sm:text-sm"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Toggle task completion with visual feedback
      function toggleTask(taskId, checkbox) {
        const originalState = checkbox.checked;

        // Show loading state
        checkbox.disabled = true;

        fetch(`{% url 'toggle' 0 %}`.replace("0", taskId), {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Update the UI without reloading
              const taskTitle = document.getElementById(`task-title-${taskId}`);
              const statusBadge = document.getElementById(
                `task-status-${taskId}`
              );

              // Toggle strikethrough and colors
              if (data.completed) {
                taskTitle.classList.add("line-through", "text-gray-500");
                statusBadge.className =
                  "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 transition-all duration-200";
                statusBadge.textContent = "Completed";
              } else {
                taskTitle.classList.remove("line-through", "text-gray-500");
                // Check if overdue
                const isOverdue = statusBadge.textContent === "Overdue";
                if (isOverdue) {
                  statusBadge.className =
                    "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 transition-all duration-200";
                  statusBadge.textContent = "Overdue";
                } else {
                  statusBadge.className =
                    "inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 transition-all duration-200";
                  statusBadge.textContent = "Pending";
                }
              }

              // Show success feedback
              showNotification(
                `Task ${data.completed ? "completed" : "marked as pending"}!`,
                "success"
              );
            } else {
              // Revert checkbox if error
              checkbox.checked = !originalState;
              showNotification("Error updating task status", "error");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            checkbox.checked = !originalState;
            showNotification("Error updating task status", "error");
          })
          .finally(() => {
            checkbox.disabled = false;
          });
      }

      // Delete confirmation modal
      function confirmDelete(taskId, taskTitle) {
        document.getElementById("taskTitle").textContent = taskTitle;
        document.getElementById("deleteForm").action =
          `{% url 'delete' 0 %}`.replace("0", taskId);
        document.getElementById("deleteModal").classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("deleteModal").classList.add("hidden");
      }

      // Helper function to get CSRF token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Notification system
      function showNotification(message, type = "info") {
        // Remove existing notification
        const existingNotification = document.getElementById("notification");
        if (existingNotification) {
          existingNotification.remove();
        }

        const notification = document.createElement("div");
        notification.id = "notification";
        notification.className = `fixed top-4 right-4 z-50 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-300 translate-x-0`;

        const bgColor =
          type === "success"
            ? "bg-green-50"
            : type === "error"
            ? "bg-red-50"
            : "bg-blue-50";
        const textColor =
          type === "success"
            ? "text-green-800"
            : type === "error"
            ? "text-red-800"
            : "text-blue-800";
        const icon =
          type === "success"
            ? "fa-check-circle"
            : type === "error"
            ? "fa-exclamation-circle"
            : "fa-info-circle";

        notification.innerHTML = `
                <div class="p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="fas ${icon} ${textColor} text-lg"></i>
                        </div>
                        <div class="ml-3 w-0 flex-1 pt-0.5">
                            <p class="text-sm font-medium text-gray-900">${message}</p>
                        </div>
                        <div class="ml-4 flex-shrink-0 flex">
                            <button class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500" onclick="this.parentElement.parentElement.parentElement.remove()">
                                <span class="sr-only">Close</span>
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

        document.body.appendChild(notification);

        // Auto remove after 3 seconds
        setTimeout(() => {
          if (notification.parentElement) {
            notification.style.transform = "translateX(100%)";
            setTimeout(() => notification.remove(), 300);
          }
        }, 3000);
      }

      // Close modal on background click
      document
        .getElementById("deleteModal")
        .addEventListener("click", function (e) {
          if (e.target.id === "deleteModal") {
            closeModal();
          }
        });

      // Add smooth animations for page load
      document.addEventListener("DOMContentLoaded", function () {
        const taskItems = document.querySelectorAll("li");
        taskItems.forEach((item, index) => {
          item.style.opacity = "0";
          item.style.transform = "translateY(10px)";
          setTimeout(() => {
            item.style.transition = "all 0.3s ease";
            item.style.opacity = "1";
            item.style.transform = "translateY(0)";
          }, index * 50);
        });
      });
    </script>
  </body>
</html>
